<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON TACTICS: ULTIMATE</title>
    <style>
        :root {
            --bg: #020617;
            --panel: #1e293b;
            --primary: #38bdf8;
            --accent-x: #fb7185;
            --accent-o: #34d399;
            --text: #f1f5f9;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            letter-spacing: 4px;
            font-size: 1.8rem;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            margin-bottom: 5px;
        }

        /* --- СТАТУС --- */
        .status {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            color: #94a3b8;
            height: 1.5rem;
            text-transform: uppercase;
        }

        /* --- ПАНЕЛЬ НАСТРОЕК --- */
        .settings-panel {
            background: var(--panel);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .settings-panel.hidden { display: none; }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .label { 
            font-size: 0.75rem; 
            color: #64748b; 
            font-weight: 800; 
            text-transform: uppercase; 
            width: 70px; 
        }

        .group { 
            display: flex; 
            flex: 1; 
            background: rgba(0,0,0,0.25); 
            padding: 4px; 
            border-radius: 12px; 
        }

        .t-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .t-btn.active { 
            background: var(--primary); 
            color: #020617; 
            box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3);
        }
        
        .t-btn:disabled {
            opacity: 0.1;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* --- ИГРОВОЕ ПОЛЕ --- */
        .board-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .board {
            display: grid;
            width: 100%;
            height: 100%;
            gap: 10px;
            /* Переменные управляются через JS */
            grid-template-columns: repeat(var(--cols, 3), 1fr);
            grid-template-rows: repeat(var(--cols, 3), 1fr);
        }

        .cell {
            background: #0f172a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            aspect-ratio: 1 / 1; /* ЖЕСТКИЙ КВАДРАТ */
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.1s, background 0.2s;
            position: relative;
            overflow: hidden;
        }

        .cell:active { transform: scale(0.95); }
        
        .cell span {
            font-size: var(--fs, 3rem);
            font-weight: 900;
            line-height: 0;
        }

        .cell.x span { color: var(--accent-x); text-shadow: 0 0 15px var(--accent-x); }
        .cell.o span { color: var(--accent-o); text-shadow: 0 0 15px var(--accent-o); }

        .cell.win { 
            background: var(--primary); 
            animation: pulse 0.6s infinite alternate;
        }
        .cell.win span { color: #020617; text-shadow: none; }

        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        /* --- КНОПКИ УПРАВЛЕНИЯ --- */
        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 10px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 1rem;
            letter-spacing: 1px;
            transition: 0.2s;
        }

        .btn-main { 
            background: linear-gradient(135deg, #38bdf8, #0ea5e9); 
            color: #020617;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        .btn-set { 
            background: #334155; 
            color: #f1f5f9; 
        }

        .btn:active { transform: translateY(2px); opacity: 0.9; }
        
        .locked { pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>NEON TACTICS</h1>

    <div class="status" id="status">ГОТОВ К ИГРЕ</div>

    <div class="settings-panel" id="settings-ui">
        <div class="row">
            <span class="label">Поле</span>
            <div class="group" id="g-size">
                <button class="t-btn active" onclick="setOpt('size', 3, this)">3x3</button>
                <button class="t-btn" onclick="setOpt('size', 4, this)">4x4</button>
                <button class="t-btn" onclick="setOpt('size', 5, this)">5x5</button>
            </div>
        </div>
        <div class="row">
            <span class="label">Победа</span>
            <div class="group" id="g-win">
                <button class="t-btn active" data-v="3" onclick="setOpt('win', 3, this)">3</button>
                <button class="t-btn" data-v="4" onclick="setOpt('win', 4, this)">4</button>
                <button class="t-btn" data-v="5" onclick="setOpt('win', 5, this)">5</button>
            </div>
        </div>
        <div class="row">
            <span class="label">Сложность</span>
            <div class="group" id="g-diff">
                <button class="t-btn" onclick="setOpt('diff', 'easy', this)">ИЗИ</button>
                <button class="t-btn active" onclick="setOpt('diff', 'hard', this)">БОГ</button>
            </div>
        </div>
        <div class="row">
            <span class="label">Первый</span>
            <div class="group" id="g-start">
                <button class="t-btn active" onclick="setOpt('start', 'p', this)">Я</button>
                <button class="t-btn" onclick="setOpt('start', 'b', this)">БОТ</button>
            </div>
        </div>
    </div>

    <div class="board-container">
        <div class="board" id="board"></div>
    </div>

    <div class="controls">
        <button class="btn btn-set" onclick="toggleSettings()">⚙️ ОПЦИИ</button>
        <button class="btn btn-main" onclick="initGame()">ИГРАТЬ</button>
    </div>
</div>

<script>
    let opts = { size: 3, win: 3, diff: 'hard', start: 'p' };
    let game = { board: [], active: false, turn: 'X', mySym: 'X', botSym: 'O' };

    function setOpt(key, val, el) {
        opts[key] = val;
        const parent = el.parentElement;
        [...parent.children].forEach(b => b.classList.remove('active'));
        el.classList.add('active');

        // Валидация условий победы
        if (key === 'size') {
            const winBtns = document.getElementById('g-win').children;
            [...winBtns].forEach(btn => {
                const v = parseInt(btn.getAttribute('data-v'));
                if (v > opts.size) {
                    btn.disabled = true;
                    btn.classList.remove('active');
                    if (opts.win === v) {
                        opts.win = opts.size;
                        [...winBtns].find(b => parseInt(b.getAttribute('data-v')) === opts.size).classList.add('active');
                    }
                } else {
                    btn.disabled = false;
                }
            });
            // Обновляем вид пустого поля сразу
            renderEmpty();
        }
    }

    function toggleSettings() {
        document.getElementById('settings-ui').classList.toggle('hidden');
    }

    function renderEmpty() {
        const bEl = document.getElementById('board');
        bEl.innerHTML = '';
        bEl.style.setProperty('--cols', opts.size);
        const fs = opts.size === 3 ? '3.5rem' : opts.size === 4 ? '2.5rem' : '1.8rem';
        bEl.style.setProperty('--fs', fs);
        for(let i=0; i < opts.size*opts.size; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerHTML = `<span></span>`;
            bEl.appendChild(cell);
        }
    }

    function initGame() {
        game.active = true;
        game.board = Array(opts.size * opts.size).fill(null);
        game.turn = 'X';
        game.mySym = 'X';
        game.botSym = 'O';
        
        document.getElementById('settings-ui').classList.add('hidden');
        renderBoard();
        
        if (opts.start === 'b') {
            game.mySym = 'O';
            game.botSym = 'X';
            setStatus('БОТ ДУМАЕТ...');
            setTimeout(botMove, 600);
        } else {
            updateStatus();
        }
    }

    function renderBoard() {
        const bEl = document.getElementById('board');
        bEl.innerHTML = '';
        bEl.style.setProperty('--cols', opts.size);
        const fs = opts.size === 3 ? '3.5rem' : opts.size === 4 ? '2.5rem' : '1.8rem';
        bEl.style.setProperty('--fs', fs);

        game.board.forEach((val, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell' + (val ? ' ' + val.toLowerCase() : '');
            cell.innerHTML = `<span>${val || ''}</span>`;
            cell.onclick = () => userMove(i);
            bEl.appendChild(cell);
        });
    }

    function userMove(i) {
        if (!game.active || game.board[i] || game.turn !== game.mySym) return;
        makeMove(i, game.mySym);
        if (game.active) {
            setTimeout(botMove, 500);
        }
    }

    function makeMove(i, sym) {
        game.board[i] = sym;
        renderBoard();
        const winLine = checkWin(game.board, sym);
        if (winLine) {
            game.active = false;
            winLine.forEach(idx => document.getElementById('board').children[idx].classList.add('win'));
            setStatus(sym === game.mySym ? 'ПОБЕДА!' : 'БОТ ВЫИГРАЛ');
            return;
        }
        if (!game.board.includes(null)) {
            game.active = false;
            setStatus('НИЧЬЯ');
            return;
        }
        game.turn = game.turn === 'X' ? 'O' : 'X';
        updateStatus();
    }

    function botMove() {
        if (!game.active) return;
        let idx;
        
        // Попытка мгновенно выиграть
        idx = findBest(game.botSym);
        // Если нет — блокировка игрока
        if (idx === null) idx = findBest(game.mySym);
        
        // Если совсем ничего — центр или случайно
        if (idx === null) {
            const center = Math.floor(game.board.length / 2);
            if (!game.board[center]) idx = center;
            else {
                const empty = game.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                idx = empty[Math.floor(Math.random() * empty.length)];
            }
        }
        
        makeMove(idx, game.botSym);
    }

    function findBest(sym) {
        for (let i = 0; i < game.board.length; i++) {
            if (!game.board[i]) {
                let temp = [...game.board];
                temp[i] = sym;
                if (checkWin(temp, sym)) return i;
            }
        }
        return null;
    }

    function checkWin(b, sym) {
        const s = opts.size;
        const w = opts.win;
        const lines = [];

        // Горизонтали
        for (let r = 0; r < s; r++) {
            for (let c = 0; c <= s - w; c++) {
                let l = []; for (let k = 0; k < w; k++) l.push(r * s + (c + k));
                lines.push(l);
            }
        }
        // Вертикали
        for (let c = 0; c < s; c++) {
            for (let r = 0; r <= s - w; r++) {
                let l = []; for (let k = 0; k < w; k++) l.push((r + k) * s + c);
                lines.push(l);
            }
        }
        // Диагонали
        for (let r = 0; r <= s - w; r++) {
            for (let c = 0; c <= s - w; c++) {
                let l1 = []; for (let k = 0; k < w; k++) l1.push((r + k) * s + (c + k));
                lines.push(l1);
                let l2 = []; for (let k = 0; k < w; k++) l2.push((r + k) * s + (c + w - 1 - k));
                lines.push(l2);
            }
        }

        for (let line of lines) {
            if (line.every(i => b[i] === sym)) return line;
        }
        return null;
    }

    function updateStatus() {
        if (!game.active) return;
        setStatus(game.turn === game.mySym ? 'Твой ход' : 'Бот думает...');
    }

    function setStatus(txt) { document.getElementById('status').innerText = txt; }

    // Первый запуск
    renderEmpty();
</script>

</body>
</html>
